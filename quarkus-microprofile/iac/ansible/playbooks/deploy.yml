---
- name: Deploy QMP Service to OpenShift
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    image_registry: image-registry.openshift-image-registry.svc:5000

  tasks:
    - name: Create namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ namespace }}"

    - name: Deploy application
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: "{{ app_name }}"
            namespace: "{{ namespace }}"
            labels:
              app: "{{ app_name }}"
              env: "{{ env }}"
          spec:
            replicas: "{{ replicas }}"
            selector:
              matchLabels:
                app: "{{ app_name }}"
            template:
              metadata:
                labels:
                  app: "{{ app_name }}"
                  env: "{{ env }}"
              spec:
                containers:
                  - name: "{{ app_name }}"
                    image: "{{ image_registry }}/{{ namespace }}/{{ app_name }}:{{ image_tag }}"
                    ports:
                      - containerPort: 8080
                        name: http
                    resources: "{{ resources }}"
                    livenessProbe:
                      httpGet:
                        path: /q/health/live
                        port: 8080
                      initialDelaySeconds: 10
                      periodSeconds: 10
                    readinessProbe:
                      httpGet:
                        path: /q/health/ready
                        port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 5

    - name: Create service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ app_name }}"
            namespace: "{{ namespace }}"
            labels:
              app: "{{ app_name }}"
          spec:
            selector:
              app: "{{ app_name }}"
            ports:
              - port: 8080
                targetPort: 8080
                name: http

    - name: Create route
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: "{{ app_name }}"
            namespace: "{{ namespace }}"
            labels:
              app: "{{ app_name }}"
          spec:
            to:
              kind: Service
              name: "{{ app_name }}"
            port:
              targetPort: http
            tls:
              termination: edge
              insecureEdgeTerminationPolicy: Redirect
